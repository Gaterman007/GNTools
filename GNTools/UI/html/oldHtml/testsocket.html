<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OctoPrint WebSocket Example</title>
</head>
<body>
  <h1>OctoPrint Push Updates</h1>
  <pre id="log"></pre>

  <script>
    // üîß Remplace par l'adresse de ton OctoPrint
    const host = "10.0.0.108:5000";  
    const apiKey = "w3hB9JoyaOEj07EWqCLUbpjrsPtbYXp7cbkw8MqT_x4";  

    // Cr√©ation de la connexion
   // WebSocket OctoPrint avec API key dans l‚ÄôURL
    const wsUrl = `ws://${host}/sockjs/websocket?apikey=${apiKey}`;
    const socket = new WebSocket(wsUrl);

    const log = document.getElementById("log");

    socket.onopen = () => {
      log.textContent += "‚úÖ Connect√© au WebSocket OctoPrint\n";
	  
	  // Auth doit √™tre envoy√© dans un tableau √† cause de SockJS
	  socket.send(JSON.stringify([{ auth: apiKey }]));
	  // √âtape 4 : Abonnement aux √©v√©nements
      socket.send(JSON.stringify({
        subscribe: {
          events: true
        }
      }));
	  // Auth obligatoire
	  //socket.send(JSON.stringify({ auth: apiKey }));
	  log.textContent += "üîë Auth envoy√©\n";
    };

    socket.onmessage = (event) => {
	  log.textContent += "üì© message recu\n";
      try {
        // Avec SockJS, le payload arrive comme `a["..."]`
        let data = event.data;

        // Si c‚Äôest un tableau JSON encod√© par SockJS ‚Üí parse le premier √©l√©ment
        if (data.startsWith("a")) {
          const arr = JSON.parse(data.substring(1));
          data = arr[0]; 
        }

        const parsed = JSON.parse(data);
        log.textContent += "üì© " + JSON.stringify(parsed, null, 2) + "\n";
      } catch (e) {
        log.textContent += "üì© " + event.data + "\n";
      }
    };

    socket.onclose = (event) => {
      log.textContent += `üîå Connexion ferm√©e (code ${event.code})\n`;
    };
    socket.onerror = (error) => {
      log.textContent += "‚ö†Ô∏è Erreur: " + error.message + "\n";
    };
  </script>
</body>
</html>