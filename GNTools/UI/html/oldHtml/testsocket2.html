<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OctoPrint WebSocket Example</title>
</head>
<body>
  <h1>OctoPrint Push Updates</h1>
  <pre id="log"></pre>
  <script>
  
	const log = document.getElementById("log");
	
    // üîß Remplace par l'adresse de ton OctoPrint
    const host = "http://10.0.0.108:5000";  
    const apiKey = "w3hB9JoyaOEj07EWqCLUbpjrsPtbYXp7cbkw8MqT_x4";  

	// √âtape 1 : Connexion √† l'API REST pour obtenir le nom d'utilisateur et la session
    fetch(host + "/api/login?passive=true", {
	  method: "POST",
	  headers: {
	    "Content-Type": "application/json",
	    "X-Api-Key": apiKey   // on passe la cl√© ici
	  },
	  body: "{}"   // obligatoire pour POST mais vide
    })
	  .then(response => response.json())
	  .then(data => {
		const auth = `${data.name}:${data.session}`;
		const socketUrl = host + '/sockjs/websocket';

		// √âtape 2 : Connexion au WebSocket
		const socket = new WebSocket(socketUrl);

		socket.onopen = () => {
		  log.textContent += "‚úÖ Connect√© au WebSocket OctoPrint" + "\n";

		  // √âtape 3 : Envoi de l'authentification
		  socket.send(JSON.stringify({ auth }));
		  log.textContent += "üîë Auth envoy√©" + "\n";

		  // √âtape 4 : Abonnement aux √©v√©nements
		  socket.send(JSON.stringify({
			subscribe: {
			  events: true
			}
		  }));
		  log.textContent += "üîî Abonnement aux √©v√©nements" + "\n";
		};

	    socket.onmessage = (event) => {
		  try {
		    const msg = JSON.parse(event.data);

		    // üìå Cas 1 : message d'√©v√©nement
		    if (msg.event) {
			  const type = msg.event.type;
			  const payload = msg.event.payload || {};

			  switch (type) {
			    case "Connected":
				  log.textContent += "üîå Imprimante connect√©e" + "\n";
				  break;
			    case "Disconnected":
				  log.textContent += "‚ùå Imprimante d√©connect√©e" + "\n";
				  break;
			    case "PrintStarted":
				  log.textContent += "‚ñ∂Ô∏è Impression d√©marr√©e : " + payload.name + "\n";
				  break;
			    case "PrintDone":
				  log.textContent += "‚úÖ Impression termin√©e : " + payload.name + "\n";
				  break;
			    case "PrintFailed":
				  log.textContent += "‚ö†Ô∏è Impression √©chou√©e : " + payload.name + "\n";
				  break;
			    case "Error":
				  log.textContent += "üí• Erreur : " + payload.error + "\n";
				  break;
			    default:
				  log.textContent += "üì© Autre √©v√©nement: " + type + "\n";
				  break;
			  }
		    }

		    // üìå Cas 2 : donn√©es plugin (ex: temp√©rature)
		    if (msg.plugin === "temperature") {
			  log.textContent += `üå° Temp√©rature : ${JSON.stringify(msg.data)}` + "\n";
		    }

		  } catch (e) {
		    console.error("Erreur parsing WS:", e);
		  }
	    };
		socket.onerror = (error) => {
		  console.error("‚ùå Erreur WebSocket:", error);
		};

		socket.onclose = () => {
		  log.textContent += "üîå WebSocket ferm√©" + "\n";
		};
	  })
	  .catch(error => {
		console.error("‚ùå Erreur lors de la connexion √† l'API REST:", error);
	  });
  </script>
</body>
</html>